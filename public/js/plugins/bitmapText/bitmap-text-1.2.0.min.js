Kiwi.Plugins.BitmapText={name:"BitmapText",version:"1.2.0"},Kiwi.PluginManager.register(Kiwi.Plugins.BitmapText),"undefined"==typeof Kiwi.Plugins.GameObjects&&(Kiwi.Plugins.GameObjects={}),Kiwi.Plugins.GameObjects.BitmapText=function(a,b,c,d,e){Kiwi.Entity.call(this,a,d,e),"undefined"==typeof c&&(c=null),this._align=Kiwi.Plugins.GameObjects.BitmapText.LEFT,this._alphabeticalCells={a:26,A:0,b:27,B:1,c:28,C:2,d:29,D:3,e:30,E:4,f:31,F:5,g:32,G:6,h:33,H:7,i:34,I:8,j:35,J:9,k:36,K:10,l:37,L:11,m:38,M:12,n:39,N:13,o:40,O:14,p:41,P:15,q:42,Q:16,r:43,R:17,s:44,S:18,t:45,T:19,u:46,U:20,v:47,V:21,w:48,W:22,x:49,X:23,y:50,Y:24,z:51,Z:25,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,".":62,$:63,",":64,"!":65,"#":66," ":67},this._lines=[],this._smooth=!1,this._tempDirty=!0,this.atlas=b,this.defaultCell=67,this.maxWidth=null,this.punctionationChars=[".","!","?",":",";",",","-"],this.supported=!0,this.text=c,this.atlas.type==Kiwi.Textures.TextureAtlas.SINGLE_IMAGE?(this.supported=!1,this.game.debugOption==Kiwi.DEBUG_ON&&Kiwi.Log.warn("Single Images will not work with the Bitmap Text GameObject!")):(this.game.renderOption===Kiwi.RENDERER_WEBGL?(this.glRenderer=this.game.renderer.requestSharedRenderer("TextureAtlasRenderer"),this._pt1=new Kiwi.Geom.Point,this._pt2=new Kiwi.Geom.Point,this._pt3=new Kiwi.Geom.Point,this._pt4=new Kiwi.Geom.Point):(this._tempCanvas=document.createElement("canvas"),this._tempCanvas.width=2,this._tempCanvas.height=2,this._tempCtx=this._tempCanvas.getContext("2d")),this._tempWidth=0,this._tempHeight=0,this._tempWord=[]),this._setTextureSharpness(this._smooth)},Kiwi.extend(Kiwi.Plugins.GameObjects.BitmapText,Kiwi.Entity),Object.defineProperties(Kiwi.Plugins.GameObjects.BitmapText.prototype,{alphabeticalCells:{get:function(){return this._alphabeticalCells},set:function(a){this._tempDirty=!0,this._alphabeticalCells=a},enumerable:!0,configurable:!0},align:{get:function(){return this._align},set:function(a){this._tempDirty=!0,this._align=a},enumerable:!0,configurable:!0},smooth:{get:function(){return this._smooth},set:function(a){this._smooth=a,this._setTextureSharpness(a)}},text:{get:function(){return this._text},set:function(a){this._tempDirty=!0,this._text=a},enumerable:!0,configurable:!0},width:{get:function(){return this._tempWidth},enumerable:!0,configurable:!0}}),Kiwi.Plugins.GameObjects.BitmapText.remap=function(a,b){for(var c in a)a[c].remap(b)},Kiwi.Plugins.GameObjects.BitmapText.prototype._addTempWord=function(){var a,b,c;if("undefined"!=typeof this._tempWord[0]&&this._tempWord[this._tempWord.length-1].line-this._tempWord[0].line>1)this._multiLineTextBreak();else{for(b=this._lines[this._lines.length-1],c=0;c<this._tempWord.length;c++)a=this._tempWord[c].cell,(0!==b.text.length||" "!==this._tempWord[c]["char"])&&(b.text.push(a),b.width+=a.w);this._tempWord.length=0}},Kiwi.Plugins.GameObjects.BitmapText.prototype._multiLineText=function(){var a,b,c,d;for(this._tempWord=[],a=0;a<this.text.length;a++)if(b=this.atlas.cells[this.cellNumber(this.text[a])],"undefined"!=typeof b&&null!==typeof b){if((" "===this.text[a]||1===this._tempWord.length&&" "===this._tempWord[0]["char"])&&this._addTempWord(),c=this._tempWidth+parseInt(b.w,10),c>=this.maxWidth){for(this._tempWidth=0,d=0;d<this._tempWord.length;d++)this._tempWidth+=parseInt(this._tempWord[d].cell.w,10);this._tempWidth+=parseInt(b.w,10),this._lines.push({text:[],height:0,width:0})}else this._tempWidth=c;this._lines[this._lines.length-1].height<b.h&&(this._lines[this._lines.length-1].height=b.h),this._tempWord.push({cell:b,"char":this.text[a],line:this._lines.length-1,cw:this._tempWidth}),-1!==this.punctionationChars.indexOf(this.text[a])&&this._addTempWord()}for(this._addTempWord(),this._tempHeight=0,a=0;a<this._lines.length;a++)this._tempHeight+=this._lines[a].height;this._lines.length>0&&(this._tempWidth=this.maxWidth)},Kiwi.Plugins.GameObjects.BitmapText.prototype._multiLineTextBreak=function(){var a,b=this._tempWord[this._tempWord.length-1].line-this._tempWord[0].line;for(this._lines.splice(this._lines.length-b,b),this._tempWidth=this._tempWord[0].cw-this._tempWord[0].cell.w,a=0;a<this._tempWord.length;a++)this._tempWidth+=this._tempWord[a].cell.w,this._tempWidth>=this.maxWidth&&(this._tempWidth=this._tempWord[a].cell.w,this._lines.push({text:[],height:0,width:0})),this._lines[this._lines.length-1].height<this._tempWord[a].cell.h&&(this._lines[this._lines.length-1].height=this._tempWord[a].cell.h),this._lines[this._lines.length-1].text.push(this._tempWord[a].cell),this._lines[this._lines.length-1].width+=this._tempWord[a].cell.w;this._tempWord.length=0},Kiwi.Plugins.GameObjects.BitmapText.prototype._renderText=function(){this._tempWidth=0,this._tempHeight=0,this._lines=[{text:[],height:0,width:0}],null===this.maxWidth?this._singleLineText():this._multiLineText(),this._tempDirty=!1},Kiwi.Plugins.GameObjects.BitmapText.prototype._renderToTempCanvas=function(){var a,b,c,d,e;for(this._tempCtx.clearRect(0,0,this._tempCanvas.width,this._tempCanvas.height),this._tempCanvas.width=this._tempWidth,this._tempCanvas.height=this._tempHeight,d=0,e=0,c=0;c<this._lines.length;c++){for(this.maxWidth&&(this.align===Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?d=this.maxWidth-this._lines[c].width:this.align===Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(d=.5*(this.maxWidth-this._lines[c].width))),b=0;b<this._lines[c].text.length;b++)a=this._lines[c].text[b],"undefined"!=typeof a&&(this._tempCtx.drawImage(this.atlas.image,a.x,a.y,a.w,a.h,d,e,a.w,a.h),d+=parseInt(a.w,10));d=0,e+=this._lines[c].height}},Kiwi.Plugins.GameObjects.BitmapText.prototype._setTextureSharpness=function(a){var b,c=this.game.stage.gl,d=this.atlas.glTextureWrapper;c&&d&&(b=a?c.LINEAR:c.NEAREST,c.bindTexture(c.TEXTURE_2D,d.texture),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,b),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,b),c.bindTexture(c.TEXTURE_2D,null))},Kiwi.Plugins.GameObjects.BitmapText.prototype._singleLineText=function(){var a,b;for(a=0;a<this.text.length;a++)b=this.atlas.cells[this.cellNumber(this.text[a])],null!=typeof b&&(b.h>this._tempHeight&&(this._tempHeight=b.h),this._tempWidth+=parseInt(b.w,10)),this._lines[this._lines.length-1].text.push(b);this._lines[this._lines.length-1].width=this._tempWidth},Kiwi.Plugins.GameObjects.BitmapText.prototype.cellNumber=function(a){var b=this.alphabeticalCells[a];return"undefined"==typeof b?this.defaultCell:b},Kiwi.Plugins.GameObjects.BitmapText.prototype.remap=function(a){for(var b in a)this.alphabeticalCells[b]=a[b]},Kiwi.Plugins.GameObjects.BitmapText.prototype.render=function(a){var b,c,d,e;this.supported&&null!=this.text&&""!==this.text&&this.alpha>0&&this.visible&&(this._tempDirty&&(this._renderText(),this._renderToTempCanvas()),this.align==Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?this.x-=this.width:this.align==Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(this.x-=this.width/2),b=this.game.stage.ctx,b.save(),this.alpha>0&&this.alpha<=1&&(b.globalAlpha=this.alpha),b.imageSmoothingEnabled=this.smooth,c=this.transform,d=c.getConcatenatedMatrix(),e=a.transform,b.transform(d.a,d.b,d.c,d.d,d.tx,d.ty),b.drawImage(this._tempCanvas,0,0,this._tempCanvas.width,this._tempCanvas.height,-c.rotPointX,-c.rotPointY,this._tempCanvas.width,this._tempCanvas.height),b.restore(),this.align==Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?this.x+=this.width:this.align==Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(this.x+=this.width/2))},Kiwi.Plugins.GameObjects.BitmapText.prototype.renderGL=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;if(this.supported&&null!=this.text&&""!==this.text&&this.alpha>0&&this.visible){for(this._tempDirty&&this._renderText(),this.align==Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?this.x-=this.width:this.align==Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(this.x-=this.width/2),n=[],m=this.transform,h=m.getConcatenatedMatrix(),e=b.transform,o=0,p=0,i=this._pt1,j=this._pt2,k=this._pt3,l=this._pt4,g=0;g<this._lines.length;g++){for(this.maxWidth&&(this.align===Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?o=this.maxWidth-this._lines[g].width:this.align===Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(o=.5*(this.maxWidth-this._lines[g].width))),o-=this.anchorPointX,p-=this.anchorPointY,f=0;f<this._lines[g].text.length;f++)d=this._lines[g].text[f],"undefined"!=typeof d&&(i.setTo(o,p),j.setTo(o+d.w,p),k.setTo(o+d.w,p+d.h),l.setTo(o,p+d.h),i=h.transformPoint(i),j=h.transformPoint(j),k=h.transformPoint(k),l=h.transformPoint(l),n.push(i.x,i.y,d.x,d.y,this.alpha,j.x,j.y,d.x+d.w,d.y,this.alpha,k.x,k.y,d.x+d.w,d.y+d.h,this.alpha,l.x,l.y,d.x,d.y+d.h,this.alpha),o+=parseInt(d.w,10));o=0,p+=this._lines[g].height}this.align===Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN?this.x+=this.width:this.align===Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN&&(this.x+=this.width/2),this.glRenderer.concatBatch(n)}},Kiwi.Plugins.GameObjects.BitmapText.LEFT_ALIGN=0,Kiwi.Plugins.GameObjects.BitmapText.RIGHT_ALIGN=1,Kiwi.Plugins.GameObjects.BitmapText.CENTER_ALIGN=2;